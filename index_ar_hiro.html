<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Philadelphia Climate Surface AR - Hiro Marker</title>
<script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
<script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
<style>
  html,body{margin:0;padding:0;overflow:hidden;font-family:Inter,system-ui,sans-serif}
  #instructions{
    position:absolute;
    top:20px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(0,0,0,0.85);
    color:white;
    padding:15px 25px;
    border-radius:12px;
    font-size:14px;
    z-index:1000;
    text-align:center;
    backdrop-filter:blur(10px);
    max-width:80%;
  }
  #yearLabel{
    position:absolute;
    bottom:20px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(0,0,0,0.85);
    color:#38bdf8;
    padding:10px 20px;
    border-radius:8px;
    font-size:13px;
    font-weight:bold;
    font-family:monospace;
    z-index:1000;
    backdrop-filter:blur(10px);
  }
  .arjs-loader {
    height: 100%;
    width: 100%;
    position: absolute;
    top: 0;
    left: 0;
    background-color: rgba(0, 0, 0, 0.8);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .arjs-loader div {
    text-align: center;
    font-size: 1.25em;
    color: white;
  }
</style>
</head>
<body style="margin:0;overflow:hidden;">

<div class="arjs-loader">
  <div>Loading AR...</div>
</div>

<div id="instructions">
  <strong>HIRO Marker AR</strong><br>
  Print this marker in black & white: <br>
  <a href="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.png" style="color:#38bdf8" target="_blank">Download HIRO</a><br>
  <small>Keep marker flat & well-lit, 20-40cm from camera</small>
</div>
<div id="yearLabel">Loading climate data...</div>

<a-scene
  embedded
  arjs="sourceType: webcam; debugUIEnabled: false;"
  vr-mode-ui="enabled: false">

  <!-- marker -->
  <a-marker preset="hiro" id="hiroMarker" smooth="true" smoothCount="5" smoothTolerance="0.01" smoothThreshold="2">
    <a-entity
      id="climateFabric"
      position="0 0 0"
      rotation="-90 0 0"
      scale="2 1.3 1"
      climate-fabric>
    </a-entity>
  </a-marker>

  <a-entity camera></a-entity>
</a-scene>

<!-- Vertex Shader -->
<script id="vertexShader" type="x-shader/x-vertex">
/* your vertex shader exactly as you had it */
</script>

<!-- Fragment Shader -->
<script id="fragmentShader" type="x-shader/x-fragment">
/* your fragment shader exactly as you had it */
</script>

<script>
const CSV_FILE = 'yearly_climate_summary.csv';

// Remove loading overlay when AR is ready
window.addEventListener('load', function() {
  setTimeout(() => {
    const loader = document.querySelector('.arjs-loader');
    if(loader) loader.style.display = 'none';
  }, 2000);
});

// DEBUG: log marker events so you can see if HIRO is being detected
document.addEventListener('DOMContentLoaded', () => {
  const marker = document.getElementById('hiroMarker');
  if (marker) {
    marker.addEventListener('markerFound', () => {
      console.log('[CLIMATE HIRO] markerFound');
    });
    marker.addEventListener('markerLost', () => {
      console.log('[CLIMATE HIRO] markerLost');
    });
  } else {
    console.warn('[CLIMATE HIRO] marker element not found');
  }
});

AFRAME.registerComponent('climate-fabric', {
  schema: {},
  
  init: function() {
    this.years = [];
    this.anomaliesNorm = [];
    this.cumulativeNorm = [];
    this.windNorm = [];
    this.precipNorm = [];
    this.yearIdx = 0;
    this.blend = 0;
    this.lastT = performance.now() / 1000;
    this.SEC_PER_YEAR = 1.25;
    
    this.loadData();
    this.createMesh();
  },
  
  loadData: async function() {
    try {
      const response = await fetch(CSV_FILE);
      const text = await response.text();
      const lines = text.trim().split(/\r?\n/);
      const yearlyData = [];
      
      for(let i=1; i<lines.length; i++){
        const c = lines[i].split(',');
        if(c.length < 5) continue;
        const year = parseInt(c[0], 10);
        const anomaly = parseFloat(c[2]);
        const wind = parseFloat(c[3]);
        const precip = parseFloat(c[4]);
        if(Number.isFinite(year) && Number.isFinite(anomaly) && Number.isFinite(wind) && Number.isFinite(precip)) {
          yearlyData.push({year, anomaly, wind, precip});
        }
      }
      
      this.years = yearlyData.map(d => d.year);
      const rawAnom = yearlyData.map(d => d.anomaly);
      const rawWind = yearlyData.map(d => d.wind);
      const rawPrecip = yearlyData.map(d => d.precip);
      
      const aMin = Math.min(...rawAnom), aMax = Math.max(...rawAnom), span = (aMax-aMin)||1;
      this.anomaliesNorm = rawAnom.map(a => (a-aMin)/span);
      
      const cum = []; 
      let acc = 0; 
      for(const a of rawAnom){ acc += a; cum.push(acc); }
      const cMin = Math.min(...cum), cMax = Math.max(...cum), cSpan = (cMax-cMin)||1;
      this.cumulativeNorm = cum.map(v => (v-cMin)/cSpan);
      
      const wMin = Math.min(...rawWind), wMax = Math.max(...rawWind), wSpan = (wMax-wMin)||1;
      this.windNorm = rawWind.map(w => (w-wMin)/wSpan);
      
      const pMin = Math.min(...rawPrecip), pMax = Math.max(...rawPrecip), pSpan = (pMax-pMin)||1;
      this.precipNorm = rawPrecip.map(p => (p-pMin)/pSpan);
      
      document.getElementById('yearLabel').textContent = 'Ready - Point at HIRO marker';
    } catch(e) {
      console.error('Failed to load CSV:', e);
      document.getElementById('yearLabel').textContent = 'Error loading climate data';
    }
  },
  
  createMesh: function() {
    const RES_X = 120, RES_Y = 78;
    const geometry = new THREE.PlaneGeometry(1, 1, RES_X, RES_Y);
    
    const material = new THREE.ShaderMaterial({
      vertexShader: document.getElementById('vertexShader').textContent,
      fragmentShader: document.getElementById('fragmentShader').textContent,
      uniforms: {
        time: { value: 0 },
        anomaly: { value: 0 },
        cumulative: { value: 0 },
        heightScale: { value: 0.12 },
        wind: { value: 0 },
        precip: { value: 0 },
        camPos: { value: new THREE.Vector3(0, 0, 0) }
      },
      transparent: true,
      side: THREE.DoubleSide,
      depthWrite: false
    });
    
    const mesh = new THREE.Mesh(geometry, material);
    this.el.setObject3D('mesh', mesh);
    this.material = material;
  },
  
  tick: function(time, deltaTime) {
    if (!this.material || this.anomaliesNorm.length === 0) return;
    
    const now = time / 1000;
    const dt = now - this.lastT;
    this.lastT = now;
    
    const lastIdx = this.anomaliesNorm.length - 1;
    if(this.yearIdx < lastIdx) {
      this.blend += dt / this.SEC_PER_YEAR;
      if(this.blend >= 1) {
        this.blend = 0;
        this.yearIdx++;
      }
    }
    
    const ia = this.yearIdx, ib = Math.min(this.yearIdx + 1, lastIdx);
    const anom = this.anomaliesNorm[ia] * (1-this.blend) + this.anomaliesNorm[ib] * this.blend;
    const cum = this.cumulativeNorm[ia] * (1-this.blend) + this.cumulativeNorm[ib] * this.blend;
    const wind = this.windNorm[ia] * (1-this.blend) + this.windNorm[ib] * this.blend;
    const precip = this.precipNorm[ia] * (1-this.blend) + this.precipNorm[ib] * this.blend;
    const year = Math.round(this.years[ia] * (1-this.blend) + this.years[ib] * this.blend);
    
    this.material.uniforms.time.value = now;
    this.material.uniforms.anomaly.value = anom;
    this.material.uniforms.cumulative.value = cum;
    this.material.uniforms.wind.value = wind;
    this.material.uniforms.precip.value = precip;
    
    const camera = this.el.sceneEl.camera;
    if(camera) {
      this.material.uniforms.camPos.value.copy(camera.position);
    }
    
    document.getElementById('yearLabel').textContent = `Year: ${year}`;
  }
});
</script>
</body>
</html>
